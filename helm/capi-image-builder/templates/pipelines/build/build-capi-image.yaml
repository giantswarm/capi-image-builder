---
apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: build-capi-image
spec:
  params:
  - name: k8sVersion
  workspaces:
  - name: output-ws
  {{ if .Values.output.s3.enabled }}
  - name: secrets
  {{ end }}
  tasks:
    - name: build-capi-image
      timeout: 6h
      taskRef:
        name: build-capi-image
      params:
        - name: ACCELERATOR
          value: 'none'
        - name: KUBERNETES_VERSION
          value: $(params.k8sVersion)
        - name: PACKER_LOG
          value: '1'
        - name: build-image
          value: "{{.Values.image.registry}}/{{.Values.image.name}}:{{.Values.image.tag}}"
        - name: CPUS
          value: '2'
        - name: MEMORY
          value: '4096'

        - name: make-target
          value: "build-qemu-ubuntu-2004"
          
      workspaces:
      - name: output
        workspace: output-ws

    {{ if .Values.output.s3.enabled }}
    - name: s3-upload-image
      taskRef:
        name: aws-cli
      runAfter:
      - build-capi-image
      params:
      - name: SCRIPT
        value: |
          set -x
          files=($(find $(workspaces.source.path)))
          for file in "${files[@]}"; do
            aws $1 $(cat /root/.aws/cli-params) cp ${file} s3://$(cat /root/.aws/bucket-name)/
          done
      - name: ARGS
        value:
        - s3
      workspaces:
      - name: secrets
        workspace: secrets
      - name: source
        workspace: output-ws
    {{ end }}
